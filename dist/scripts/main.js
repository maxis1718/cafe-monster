"use strict";function screenDivision(a,e){var o=screen.width;return e&&(o-=e),o/a}function savePosition(a){position.lat=a.coords&&a.coords.latitude,position.lon=a.coords&&a.coords.longitude,console.log("geolocation updated:",position)}var iconSet={wifi:"fa-wifi","插座":"fa-plug","限時":"fa-hourglass-half","刷卡":"fa-credit-card","服務費":"fa-money","捷運站":"fa-subway","大桌":"fa-laptop","訂位":"fa-calendar-check-o","安靜":"fa-bell-slash-o","書架":"fa-book","低消":"fa-usd","吸菸":"fa-magic","戶外座":"fa-umbrella"};Parse.initialize("wTYRjN5abTd2I2BgdaBbbWupwB9Slv0fgd6SauW3","O8cF0dYOlwfce6uVLzEXlKfhp1SEhyVxJiPsma8K");var tagMargin=0,tagPerRow=3,cafe,relation,isNewCafe=!1,position={},candidateContainer=$(".tags-wrap"),Cafe=Parse.Object.extend("Cafe"),CafeQuery=new Parse.Query(Cafe),Info=Parse.Object.extend("Info"),InfoQuery=new Parse.Query(Info),clickHandler=function(a){var e=$(this).hasClass("selected");$(this).toggleClass("selected"),e?(console.log("remove",a.data.info),a.data.relation.remove(a.data.info)):(console.log("add",a.data.info),a.data.relation.add(a.data.info))},clearContent=function(a){a.data&&a.data.clearAll&&$("#cafe-name").val("").focus(),$("geo").hasClass("active")&&$("geo").removeClass("active"),$(".tags-wrap").html(""),$("#cafe-addr").val(""),$("#cafe-tel").val("")},searchHandler=function(a){if(!a.data||!a.data.keyup||13===a.keyCode){clearContent(a);var e=$(".search").find("i");e.toggleClass("d-n"),CafeQuery.equalTo("name",$("#cafe-name").val().toLowerCase()),CafeQuery.find().then(function(a){return e.toggleClass("d-n"),a.length?(console.log(a[0].get("name")),console.log(a[0].get("address")),console.log(a[0].get("tel")),a[0].get("geo")&&$(".geo").addClass("active"),Parse.Promise.as(a[0])):Parse.Promise.error("this is a new cafe")}).then(function(a){return $(".search").addClass("active"),cafe=a,$("#cafe-addr").val(cafe.get("address")),$("#cafe-tel").val(cafe.get("tel")),relation=cafe.relation("infos"),isNewCafe=!1,InfoQuery.find()},function(a){return console.log(a),cafe=new Parse.Object("Cafe"),relation=cafe.relation("infos"),isNewCafe=!0,InfoQuery.find()}).then(function(a){var e,o,n=Math.floor(screenDivision(tagPerRow,tagMargin*tagPerRow*2));return a.forEach(function(a){e=a.get("name"),o=iconSet[e];var t=$("<div/>").addClass("tag").addClass("op-0").attr("id",a.id).appendTo(candidateContainer).on("click",{info:a,relation:relation},clickHandler).css({width:n,height:n,margin:tagMargin});$("<i/>").addClass("icon fa").addClass(o).appendTo(t),$("<span/>").addClass("txt").text(e).appendTo(t)}),isNewCafe?Parse.Promise.as([]):relation.query().find()}).then(function(a){a.forEach(function(a){$("#"+a.id).addClass("selected")}),$(".tag").removeClass("op-0")})}},geoHandler=function(){var a=$(".geo").find("i");a.toggleClass("d-n"),navigator.geolocation?navigator.geolocation.getCurrentPosition(function(e){a.toggleClass("d-n"),$(".geo").addClass("active"),savePosition(e)}):(a.toggleClass("d-n"),console.log("Geolocation is not supported by this browser."))},submitHandler=function(a){if($(".save-icons").find(".status").toggleClass("d-n"),cafe.set("name",$("#cafe-name").val()),cafe.set("address",$("#cafe-addr").val()),cafe.set("tel",$("#cafe-tel").val()),position&&position.lat&&position.lon){var e=new Parse.GeoPoint({latitude:parseFloat(position.lat),longitude:parseFloat(position.lon)});cafe.set("geo",e)}cafe.save(null,{success:function(){$(".save-icons").find(".status").toggleClass("d-n"),console.log("save ok")},error:function(){$(".save-icons").find(".status").toggleClass("d-n"),console.log("save failed")}}),console.log(a.target),console.log("save the cafe",cafe.get("name"))};$(".save-btn").on("click",submitHandler),$(".search").on("click",searchHandler),$(".geo").on("click",geoHandler),$(".add-btn").on("click",{clearAll:!0},searchHandler),$("input").on("focus",function(){$(this).parents(".info-wrap").toggleClass("active")}).on("blur",function(){$(this).parents(".info-wrap").toggleClass("active")}).keyup({keyup:!0},searchHandler),$(document).on("ready",{clearAll:!0},function(a){searchHandler(a)});